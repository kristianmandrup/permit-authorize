// Generated by LiveScript 1.2.0
(function(){
  var requires, ability, lo, User, Book, createRequest, createUser, createPermit, Allower, CachedAbility, Permit, permitFor, PermitMatcher;
  requires = require('../../requires');
  requires.test('test_setup');
  ability = require('./ability/cached_abilities');
  lo = require('lodash');
  User = requires.fix('user');
  Book = requires.fix('book');
  createRequest = requires.fac('create-request');
  createUser = requires.fac('create-user');
  createPermit = requires.fac('create-permit');
  Allower = requires.lib('allower');
  CachedAbility = requires.lib('cached-ability');
  Permit = requires.lib('permit');
  permitFor = requires.permit('permit_for');
  PermitMatcher = requires.permit('permit_matcher');
  describe('CachedAbility', function(){
    var book, createBook, abilities, requests, users, permits;
    createBook = function(title){
      return new Book({
        title: title
      });
    };
    abilities = {};
    requests = {};
    users = {};
    permits = {};
    before(function(){
      book = createBook('hello');
      permits.user = permitFor('User', {
        match: function(access){
          return this.matching(access).user();
        },
        rules: function(){
          return this.ucan('view', 'book');
        }
      });
      permits.guest = permitFor('Guest', {
        match: function(access){
          return this.matching(access).role('guest');
        },
        rules: function(){
          this.ucan('read', 'book');
          return this.ucannot('write', 'book');
        }
      });
      permits.editor = permitFor('Editor', {
        match: function(access){
          return this.matching(access).role('editor');
        },
        rules: function(){
          return this.ucan(['read', 'write'], 'book');
        }
      });
      requests.user = createRequest.userAccess();
      requests.empty = createRequest.empty();
      return users.kris = createUser.kris();
    });
    describe('create', function(){
      return context('Ability for kris', function(){
        specify('is an Ability', function(){
          return ability.kris.constructor.should.eql(CachedAbility);
        });
        return describe('user', function(){
          return specify('has user kris', function(){
            return ability.kris.user.should.eql(users.kris);
          });
        });
      });
    });
    describe('allower', function(){
      specify('return Allower instance', function(){
        return ability.kris.allower(requests.empty).constructor.should.eql(Allower);
      });
      return specify('Allower sets own access-request obj', function(){
        return ability.kris.allower(requests.user).accessRequest.should.eql(requests.user);
      });
    });
    describe('allowed-for', function(){
      before(function(){});
      context('guest ability', function(){
        specify('read a book access should be allowed for guest user', function(){
          return ability.guest.allowedFor({
            action: 'read',
            subject: book
          }).should.be['true'];
        });
        return specify('write a book access should NOT be allowed for guest user', function(){
          return ability.guest.allowedFor({
            action: 'write',
            subject: book
          }).should.be['false'];
        });
      });
      return context('admin ability', function(){
        return specify('write a book access should NOT be allowed for admin user', function(){
          return ability.admin.allowedFor({
            action: 'write',
            subject: book
          }).should.be['false'];
        });
      });
    });
    return describe('not-allowed-for', function(){
      before(function(){});
      context('guest ability', function(){
        before(function(){
          return console.time('guest ability: uncached');
        });
        after(function(){
          return console.timeEnd('guest ability: uncached');
        });
        specify('read a book access should be allowed for admin user', function(){
          return ability.guest.notAllowedFor({
            action: 'read',
            subject: book
          }).should.be['false'];
        });
        return specify('write a book access should NOT be allowed for guest user', function(){
          var i$, i, results$ = [];
          for (i$ = 1; i$ <= 10; ++i$) {
            i = i$;
            results$.push(ability.guest.notAllowedFor({
              action: 'write',
              subject: book
            }).should.be['true']);
          }
          return results$;
        });
      });
      context('admin ability', function(){
        return specify('write a book access should NOT be allowed for admin user', function(){
          return ability.admin.notAllowedFor({
            action: 'write',
            subject: book
          }).should.be['true'];
        });
      });
      return context('guest ability', function(){
        before(function(){
          return console.time('guest ability: cached');
        });
        after(function(){
          return console.timeEnd('guest ability: cached');
        });
        specify('read a book access should be allowed for admin user', function(){
          return ability.guest.notAllowedFor({
            action: 'read',
            subject: book
          }).should.be['false'];
        });
        return specify('write a book access should NOT be allowed for guest user', function(){
          var i$, i, results$ = [];
          for (i$ = 1; i$ <= 10; ++i$) {
            i = i$;
            results$.push(ability.guest.notAllowedFor({
              action: 'write',
              subject: book
            }).should.be['true']);
          }
          return results$;
        });
      });
    });
  });
}).call(this);
